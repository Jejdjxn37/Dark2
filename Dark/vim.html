<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Dark Chat - ØªØ·Ø¨ÙŠÙ‚ ØªÙˆØ§ØµÙ„ Ø§Ø¬ØªÙ…Ø§Ø¹ÙŠ</title>
  <!-- ØªØ­Ù…ÙŠÙ„ Ø®Ø· "Cairo" Ù„Ø¯Ø¹Ù… Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© Ø§Ù„Ø¹ØµØ±ÙŠØ© -->
  <link href="https://fonts.googleapis.com/css?family=Cairo:400,600&display=swap" rel="stylesheet">
  <!-- ØªØ¶Ù…ÙŠÙ† Ù…ÙƒØªØ¨Ø© Socket.IO (ØªØ£ÙƒØ¯ Ù…Ù† ØªØ´ØºÙŠÙ„ Ø§Ù„Ø®Ø§Ø¯Ù…) -->
  <script src="/socket.io/socket.io.js"></script>
  <style>

  <script src="auth.js"></script>
    
    /* ØªØ¹Ø±ÙŠÙ Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø£Ù„ÙˆØ§Ù† Ø¨Ø£Ø³Ù„ÙˆØ¨ Ø¹ØµØ±ÙŠ */
    :root {
      --primary-color: #7289da;
      --secondary-color: #36393f;
      --accent-color: #99aab5;
      --text-color: #dcddde;
      --background-color: #2f3136;
      --header-bg: #202225;
      --modal-bg: #2f3136;
      --input-bg: #40444b;
      --button-bg: var(--primary-color);
    }
    * {
      box-sizing: border-box;
      font-family: 'Cairo', sans-serif;
    }
    body {
      margin: 0;
      background-color: var(--background-color);
      color: var(--text-color);
      direction: rtl;
    }
    .hidden { display: none; }
    /* --- Ø´Ø§Ø´Ø§Øª Ø¹Ø§Ù…Ø© --- */
    .screen {
      padding: 20px;
      min-height: 100vh;
    }
    /* --- ØªÙ†Ø³ÙŠÙ‚ Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ ÙˆØ§Ù„Ø£Ø²Ø±Ø§Ø± --- */
    input, select, button {
      border: none;
      border-radius: 4px;
      padding: 10px;
      font-size: 16px;
      margin: 5px 0;
    }
    input, select {
      width: 100%;
      background-color: var(--input-bg);
      color: var(--text-color);
    }
    button {
      background-color: var(--button-bg);
      color: #fff;
      cursor: pointer;
      transition: background-color 0.3s ease;
    }
    button:hover { background-color: #5b6eae; }
    a { color: var(--primary-color); cursor: pointer; text-decoration: none; }
    /* --- Ø±Ø£Ø³ Ø´Ø§Ø´Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ --- */
    .login-header {
      text-align: center;
      margin-bottom: 20px;
    }
    .login-header img {
      width: 60px;
      height: 60px;
      border-radius: 50%;
      vertical-align: middle;
      margin-left: 10px;
    }
    .login-header h1 {
      display: inline;
      font-size: 28px;
      vertical-align: middle;
      margin: 0;
    }
    /* --- Ø´Ø§Ø´Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ ÙˆØ§Ù„ØªØ³Ø¬ÙŠÙ„ --- */
    .auth-container {
      max-width: 400px;
      margin: 50px auto;
      background-color: var(--secondary-color);
      padding: 30px;
      border-radius: 8px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.5);
      text-align: center;
    }
    .auth-container h2 { margin-bottom: 20px; }
    /* --- ØªØ®Ø·ÙŠØ· Ø§Ù„Ø´Ø§Ø´Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© (Sidebar + Content) --- */
    .main-layout {
      display: flex;
      height: calc(100vh - 70px);
    }
    .sidebar {
      width: 250px;
      background-color: var(--secondary-color);
      padding: 20px;
      overflow-y: auto;
      border-right: 1px solid var(--header-bg);
    }
    .content {
      flex-grow: 1;
      background-color: var(--background-color);
      padding: 20px;
      overflow-y: auto;
    }
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background-color: var(--header-bg);
      padding: 10px 20px;
      border-bottom: 1px solid var(--header-bg);
      box-shadow: 0 2px 5px rgba(0,0,0,0.3);
    }
    .header .title {
      font-size: 22px;
      font-weight: 600;
    }
    .header .icons button {
      background: none;
      border: none;
      color: var(--text-color);
      font-size: 24px;
      margin: 0 5px;
      cursor: pointer;
    }
    /* --- Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ØºØ±Ù ÙÙŠ Sidebar --- */
    .sidebar .room-item {
      padding: 10px;
      margin-bottom: 8px;
      background-color: var(--input-bg);
      border-radius: 4px;
      cursor: pointer;
      transition: background-color 0.2s;
    }
    .sidebar .room-item:hover { background-color: var(--button-bg); }
    .sidebar .room-item span.delete-btn {
      float: left;
      background: red;
      padding: 2px 5px;
      border-radius: 4px;
      font-size: 12px;
      display: none;
      cursor: pointer;
    }
    .sidebar .room-item:hover span.delete-btn { display: inline; }
    /* --- ØªØµÙ…ÙŠÙ… ØºØ±ÙØ© Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© --- */
    .chat-header {
      padding: 10px;
      background-color: var(--header-bg);
      border-bottom: 1px solid var(--header-bg);
    }
    .chat-messages {
      height: calc(100vh - 200px);
      overflow-y: auto;
      padding: 10px;
      background-color: var(--background-color);
    }
    .chat-message {
      margin-bottom: 10px;
      padding: 8px;
      background-color: var(--input-bg);
      border-radius: 6px;
      position: relative;
    }
    .chat-message button { font-size: 12px; margin-left: 5px; }
    #typing-indicator { font-style: italic; margin: 5px 0; }
    /* --- ØªØµÙ…ÙŠÙ… Ø§Ù„Ù†ÙˆØ§ÙØ° (Ø§Ù„Ù…ÙˆØ¯Ø§Ù„Ø§Øª) --- */
    .modal {
      position: fixed;
      top: 50%;
      left: 50%;
      width: 90%;
      max-width: 500px;
      transform: translate(-50%, -50%);
      background-color: var(--modal-bg);
      border: 1px solid var(--header-bg);
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.6);
      z-index: 1000;
      text-align: center;
    }
    .modal h3 { margin-top: 0; }
    .modal-close {
      float: right;
      font-size: 18px;
      cursor: pointer;
      color: red;
    }
    /* --- Ø¥Ø´Ø¹Ø§Ø± Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨ --- */
    #account-created-modal img {
      display: block;
      margin: 0 auto 10px;
      width: 100px;
      height: 100px;
      border-radius: 50%;
    }
    /* --- Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ…Ø±ÙŠØ± Ø§Ù„Ù…Ø®ØµØµ --- */
    ::-webkit-scrollbar { width: 8px; }
    ::-webkit-scrollbar-track { background: var(--secondary-color); }
    ::-webkit-scrollbar-thumb { background: var(--button-bg); border-radius: 4px; }
    /* --- ØªØ­Ø³ÙŠÙ† Ø§Ø³ØªØ¬Ø§Ø¨Ø© Ø§Ù„ØªØµÙ…ÙŠÙ… --- */
    @media (max-width: 768px) {
      .main-layout { flex-direction: column; }
      .sidebar { width: 100%; border-right: none; border-bottom: 1px solid var(--header-bg); }
    }
  </style>
</head>
<body>
  <!-- Ø´Ø§Ø´Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ -->
  <div id="login-screen" class="screen">
    <div class="auth-container">
      <div class="login-header">
        <img src="https://via.placeholder.com/60?text=Logo" alt="Logo">
        <h1>Dark Chat</h1>
      </div>
      <h2>ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</h2>
      <input type="text" id="login-username" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…">
      <input type="password" id="login-password" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±">
      <button id="login-button">ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„</button>
      <p><a id="go-to-register">Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨</a></p>
      <p id="login-error" style="color:red;"></p>
    </div>
  </div>
  
  <!-- Ø´Ø§Ø´Ø© Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨ -->
  <div id="register-screen" class="screen hidden">
    <div class="auth-container">
      <h2>Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨</h2>
      <input type="text" id="register-username" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…">
      <input type="text" id="register-name" placeholder="Ø§Ù„Ø§Ø³Ù…">
      <input type="password" id="register-password" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±">
      <input type="password" id="register-confirm-password" placeholder="ØªØ£ÙƒÙŠØ¯ ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±">
      <button id="register-button">Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨</button>
      <p><a id="back-to-login">Ø§Ù„Ø±Ø¬ÙˆØ¹ Ø¥Ù„Ù‰ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</a></p>
      <p id="register-error" style="color:red;"></p>
    </div>
  </div>
  
  <!-- Ø¥Ø´Ø¹Ø§Ø± Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨ (Modal) -->
  <div id="account-created-modal" class="modal hidden">
    <span class="modal-close" id="close-account-created-modal">âœ–</span>
    <img src="https://via.placeholder.com/100?text=Dark+Chat" alt="Dark Chat Logo">
    <h3>Dark Chat</h3>
    <p>ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨ Ø¨Ù†Ø¬Ø§Ø­</p>
    <button id="dismiss-account-created">ØªÙ…</button>
  </div>
  
  <!-- Ø§Ù„Ø´Ø§Ø´Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© (Sidebar + Content) -->
  <div id="main-screen" class="screen hidden">
    <div class="header">
      <div class="title">
        <img id="user-avatar" src="" alt="Avatar" style="width:40px; height:40px; border-radius:50%; vertical-align:middle; margin-left:10px;">
        Dark Chat
      </div>
      <div class="icons">
        <button class="icon-button" id="admin-icon" title="Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©" style="display:none;">ğŸ‘‘</button>
        <button class="icon-button" id="settings-icon" title="Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª">âš™ï¸</button>
        <button class="icon-button" id="chat-icon" title="ØºØ±ÙØ© Ø§Ù„Ø¯Ø±Ø¯Ø´Ø©">ğŸ’¬</button>
        <button class="icon-button" id="voice-icon" title="ØºØ±ÙØ© Ø§Ù„ÙÙˆÙŠØ³">ğŸ™ï¸</button>
        <button class="icon-button" id="logout-button" title="ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬">ğŸšª</button>
      </div>
    </div>
    <div class="main-layout">
      <div class="sidebar" id="rooms-sidebar">
        <h4>Ø§Ù„ØºØ±Ù Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©</h4>
        <!-- Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ØºØ±Ù ØªØ¸Ù‡Ø± Ù‡Ù†Ø§ -->
      </div>
      <div class="content" id="content-area">
        <!-- Ù‡Ù†Ø§ Ø³ÙŠØªÙ… Ø¹Ø±Ø¶ ØºØ±ÙØ© Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© Ø£Ùˆ Ø§Ù„ÙÙˆÙŠØ³ -->
      </div>
    </div>
  </div>
  
  <!-- Ø´Ø§Ø´Ø© Ø¥Ø¯Ø®Ø§Ù„ Ø´ÙŠÙØ±Ø© ØºØ±ÙØ© Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© -->
  <div id="chat-code-screen" class="screen hidden">
    <div class="auth-container">
      <h2>Ø´ÙŠÙØ±Ø© ØºØ±ÙØ© Ø§Ù„Ø¯Ø±Ø¯Ø´Ø©</h2>
      <input type="text" id="chat-code-input" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„Ø´ÙŠÙØ±Ø©">
      <button id="enter-chat-code">Yes</button>
      <button id="cancel-chat-code">No</button>
      <p id="chat-code-error" style="color:red;"></p>
    </div>
  </div>
  
  <!-- ØºØ±ÙØ© Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© (Realâ€‘time) -->
  <div id="chat-room-screen" class="screen hidden">
    <div class="chat-header">
      <span id="chat-room-code" style="font-weight:600;"></span>
      <button class="icon-button" id="back-from-chat-room" title="Ø±Ø¬ÙˆØ¹">â†</button>
    </div>
    <div class="chat-messages" id="chat-messages"></div>
    <div id="typing-indicator"></div>
    <input type="text" id="chat-input" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„ØªÙƒ Ù‡Ù†Ø§">
    <button id="send-chat-message">Ø¥Ø±Ø³Ø§Ù„</button>
    <button id="send-file-chat">Ø¥Ø±Ø³Ø§Ù„ ØµÙˆØ±Ø©/Ù…Ù„Ù</button>
  </div>
  
  <!-- Ø´Ø§Ø´Ø© Ø¥Ø¯Ø®Ø§Ù„ Ø´ÙŠÙØ±Ø© ØºØ±ÙØ© Ø§Ù„ÙÙˆÙŠØ³ -->
  <div id="voice-code-screen" class="screen hidden">
    <div class="auth-container">
      <h2>Ø´ÙŠÙØ±Ø© ØºØ±ÙØ© Ø§Ù„ÙÙˆÙŠØ³</h2>
      <input type="text" id="voice-code-input" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„Ø´ÙŠÙØ±Ø©">
      <button id="enter-voice-code">Yes</button>
      <button id="cancel-voice-code">No</button>
      <p id="voice-code-error" style="color:red;"></p>
    </div>
  </div>
  
  <!-- ØºØ±ÙØ© Ø§Ù„ÙÙˆÙŠØ³ -->
  <div id="voice-room-screen" class="screen hidden">
    <div class="chat-header">
      <span id="voice-room-code" style="font-weight:600;"></span>
      <button class="icon-button" id="back-from-voice-room" title="Ø±Ø¬ÙˆØ¹">â†</button>
    </div>
    <div id="voice-participants" style="padding:20px;"></div>
    <div style="text-align:center; margin-top:20px;">
      <button class="icon-button" id="mic-button" title="Ø§Ù„Ù…ÙŠÙƒ">ğŸ¤</button>
      <button class="icon-button" id="speaker-button" title="Ø§Ù„Ø³Ù…Ø§Ø¹Ø©">ğŸ§</button>
      <button class="icon-button" id="exit-voice-room" title="Ù…ØºØ§Ø¯Ø±Ø©">ğŸšª</button>
    </div>
  </div>
  
  <!-- Ø´Ø§Ø´Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© (Ù„Ù„Ø£Ø¯Ù…Ù†) -->
  <div id="admin-screen" class="screen hidden">
    <div class="modal">
      <span class="modal-close" id="back-from-admin">â†</span>
      <h3>Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</h3>
      <div class="menu">
        <div class="menu-item" id="broadcast-all">Ø¥Ø±Ø³Ø§Ù„ ØªØ¹Ù…ÙŠÙ… Ù„Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</div>
        <div class="menu-item" id="broadcast-user">Ø¥Ø±Ø³Ø§Ù„ ØªØ¹Ù…ÙŠÙ… Ù„Ù…Ø³ØªØ®Ø¯Ù…</div>
        <div class="menu-item" id="manage-users">Ø¥Ø¯Ø§Ø±Ø© Ø­Ø³Ø§Ø¨Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</div>
        <div class="menu-item" id="ban-management">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø­Ø¶Ø±</div>
        <div class="menu-item" id="add-admin">Ø¥Ø¶Ø§ÙØ© Ø¥Ø¯Ø§Ø±ÙŠ</div>
        <div class="menu-item" id="admin-support">Ø§Ù„Ø¯Ø¹Ù…</div>
        <div class="menu-item" id="clear-chats">ØªØµÙÙŠØª Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø´Ø§ØªØ§Øª</div>
        <div class="menu-item" id="grant-permission">Ø¥Ø¹Ø·Ø§Ø¡ Ø¥Ø°Ù†</div>
        <div class="menu-item" id="remove-permission">Ø¥Ø²Ø§Ù„Ø© Ø¥Ø°Ù†</div>
      </div>
    </div>
  </div>
  
  <!-- Ù…ÙˆØ¯Ø§Ù„Ø§Øª Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…Ø®ØªÙ„ÙØ© -->
  <div id="profile-modal" class="modal hidden">
    <span class="modal-close" id="close-profile-modal">âœ–</span>
    <h3>ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ</h3>
    <div class="settings-option">
      <p>ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø§Ø³Ù…:</p>
      <input type="text" id="new-name" placeholder="Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯">
      <button id="update-name">Yes</button>
      <button id="cancel-update-name">No</button>
    </div>
    <div class="settings-option">
      <p>ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„ÙŠÙˆØ²Ø± (Ø¨Ø­Ø§Ø¬Ø© Ø¥Ù„Ù‰ ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø± Ø§Ù„Ø­Ø§Ù„ÙŠØ©):</p>
      <input type="password" id="current-password-username" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø± Ø§Ù„Ø­Ø§Ù„ÙŠØ©">
      <input type="text" id="new-username" placeholder="ÙŠÙˆØ²Ø± Ø¬Ø¯ÙŠØ¯">
      <button id="update-username">Yes</button>
      <button id="cancel-update-username">No</button>
    </div>
    <div class="settings-option">
      <p>ØªØ¹Ø¯ÙŠÙ„ ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø± (Ø¨Ø­Ø§Ø¬Ø© Ø¥Ù„Ù‰ ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø± Ø§Ù„Ø­Ø§Ù„ÙŠØ©):</p>
      <input type="password" id="current-password-pass" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø± Ø§Ù„Ø­Ø§Ù„ÙŠØ©">
      <input type="password" id="new-password" placeholder="ÙƒÙ„Ù…Ø© Ø³Ø± Ø¬Ø¯ÙŠØ¯Ø©">
      <button id="update-password">Yes</button>
      <button id="cancel-update-password">No</button>
    </div>
    <div class="settings-option">
      <p>ØªØ­Ø¯ÙŠØ« Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ø´Ø®ØµÙŠØ© (Ø±Ø§Ø¨Ø· URL):</p>
      <input type="text" id="new-avatar" placeholder="Ø£Ø¯Ø®Ù„ Ø±Ø§Ø¨Ø· Ø§Ù„ØµÙˆØ±Ø©">
      <button id="update-avatar">Yes</button>
      <button id="cancel-update-avatar">No</button>
    </div>
  </div>
  
  <div id="language-modal" class="modal hidden">
    <span class="modal-close" id="close-language-modal">âœ–</span>
    <h3>ØªØºÙŠÙŠØ± Ø§Ù„Ù„ØºØ©</h3>
    <select id="language-select">
      <option value="ar">Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©</option>
      <option value="en">English</option>
      <option value="ru">Ğ ÑƒÑÑĞºĞ¸Ğ¹</option>
    </select>
    <button id="save-language">Ø­ÙØ¸</button>
  </div>
  
  <div id="sound-modal" class="modal hidden">
    <span class="modal-close" id="close-sound-modal">âœ–</span>
    <h3>Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØµÙˆØª</h3>
    <div class="settings-option">
      <p>Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ù…Ø§ÙŠÙƒ:</p>
      <input type="range" id="mic-volume" min="0" max="100" value="50">
    </div>
    <div class="settings-option">
      <p>Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ø³Ù…Ø§Ø¹Ø©:</p>
      <input type="range" id="speaker-volume" min="0" max="100" value="50">
    </div>
    <div class="settings-option">
      <p>ÙˆØ¶Ø¹ Ø§Ù„Ù…Ø§ÙŠÙƒ:</p>
      <select id="mic-mode">
        <option value="press">Ø¶ØºØ· Ù„Ù„ØªØ­Ø¯Ø«</option>
        <option value="toggle">Ù…ÙØªÙˆØ­ Ø¯Ø§Ø¦Ù…</option>
      </select>
    </div>
    <button id="save-sound-settings">Ø­ÙØ¸</button>
  </div>
  
  <div id="text-modal" class="modal hidden">
    <span class="modal-close" id="close-text-modal">âœ–</span>
    <h3>Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù†Øµ</h3>
    <div class="settings-option">
      <p>Ø­Ø¬Ù… Ø§Ù„Ø®Ø·:</p>
      <input type="range" id="font-size-range" min="12" max="24" value="16">
    </div>
    <button id="save-text-settings">Ø­ÙØ¸</button>
  </div>
  
  <div id="appearance-modal" class="modal hidden">
    <span class="modal-close" id="close-appearance-modal">âœ–</span>
    <h3>Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…Ø¸Ù‡Ø±</h3>
    <div class="settings-option">
      <p>Ø§Ù„Ø®Ù„ÙÙŠØ©:</p>
      <select id="background-select">
        <option value="dark">Ø£Ø³ÙˆØ¯</option>
        <option value="light">Ø£Ø¨ÙŠØ¶</option>
      </select>
    </div>
    <div class="settings-option">
      <p>Ù„ÙˆÙ† Ø§Ù„Ø£Ø²Ø±Ø§Ø±:</p>
      <select id="button-color-select">
        <option value="blue">Ø£Ø²Ø±Ù‚</option>
        <option value="yellow">Ø£ØµÙØ±</option>
      </select>
    </div>
    <button id="save-appearance-settings">Ø­ÙØ¸</button>
  </div>
  
  <div id="support-modal" class="modal hidden" style="max-width:600px; height:70vh; overflow:auto;">
    <span class="modal-close" id="close-support-modal">âœ–</span>
    <h3>Ø§Ù„Ø¯Ø¹Ù…</h3>
    <div id="support-messages" style="height:300px; overflow-y:auto; border:1px solid var(--header-bg); padding:10px; margin-bottom:10px;"></div>
    <input type="text" id="support-input" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„ØªÙƒ">
    <button id="send-support-message">Ø¥Ø±Ø³Ø§Ù„</button>
  </div>
  
  <div id="user-management-modal" class="modal hidden" style="max-width:600px; height:70vh; overflow:auto;">
    <span class="modal-close" id="close-user-management-modal">âœ–</span>
    <h3>Ø¥Ø¯Ø§Ø±Ø© Ø­Ø³Ø§Ø¨Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</h3>
    <input type="text" id="user-search" placeholder="Ø§Ø¨Ø­Ø« Ø¹Ù† Ù…Ø³ØªØ®Ø¯Ù…">
    <div id="user-list" style="margin-top:10px;"></div>
  </div>
  
  <script>
    /***** Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø¹Ø§Ù…Ø© ÙˆØ§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø­Ù„ÙŠ *****/
    // Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø© ÙŠØªÙ… Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† localStorage
    let currentUser = null;
    let users = JSON.parse(localStorage.getItem('users')) || {};
    let chats = JSON.parse(localStorage.getItem('chats')) || {};
    let voiceRooms = JSON.parse(localStorage.getItem('voiceRooms')) || {};
    let bannedUsers = JSON.parse(localStorage.getItem('bannedUsers')) || {};
    let permissions = JSON.parse(localStorage.getItem('permissions')) || {};
    let userSettings = JSON.parse(localStorage.getItem('userSettings')) || {
      language: 'ar',
      micVolume: 50,
      speakerVolume: 50,
      micMode: 'press',
      fontSize: 16,
      background: 'dark',
      buttonColor: 'blue'
    };
    
    // Ø¯Ø§Ù„Ø© Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† localStorage (Ù…Ù‡Ù…Ø© Ø¹Ù†Ø¯ Ù…Ø­Ø§ÙˆÙ„Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„)
    function refreshUsers() {
      users = JSON.parse(localStorage.getItem('users')) || {};
      bannedUsers = JSON.parse(localStorage.getItem('bannedUsers')) || {};
    }
    
    // Ø³ÙŠØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§ØªØµØ§Ù„ Socket.IO Ø¨Ø¹Ø¯ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
    let socket = null;
    
    function saveData() {
      localStorage.setItem('users', JSON.stringify(users));
      localStorage.setItem('chats', JSON.stringify(chats));
      localStorage.setItem('voiceRooms', JSON.stringify(voiceRooms));
      localStorage.setItem('bannedUsers', JSON.stringify(bannedUsers));
      localStorage.setItem('permissions', JSON.stringify(permissions));
      localStorage.setItem('userSettings', JSON.stringify(userSettings));
    }
    
    function showScreen(screenId) {
      document.querySelectorAll('.screen').forEach(screen => screen.classList.add('hidden'));
      document.getElementById(screenId).classList.remove('hidden');
      if(screenId === 'main-screen') updateJoinedRooms();
    }
    
    /***** ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ ÙˆØ§Ù„ØªØ³Ø¬ÙŠÙ„ *****/
    document.getElementById('go-to-register').addEventListener('click', e => {
      e.preventDefault();
      showScreen('register-screen');
    });
    document.getElementById('back-to-login').addEventListener('click', e => {
      e.preventDefault();
      showScreen('login-screen');
    });
    
    // Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯
    document.getElementById('register-button').addEventListener('click', () => {
      const username = document.getElementById('register-username').value.trim();
      const name = document.getElementById('register-name').value.trim();
      const password = document.getElementById('register-password').value;
      const confirmPassword = document.getElementById('register-confirm-password').value;
      const errorP = document.getElementById('register-error');
      errorP.textContent = '';
    
      if(username.length < 3) {
        errorP.textContent = 'Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† 3 Ø£Ø­Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„.';
        return;
      }
      if(password.length < 6) {
        errorP.textContent = 'ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø± ÙŠØ¬Ø¨ Ø£Ù† ØªÙƒÙˆÙ† 6 Ø£Ø­Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„.';
        return;
      }
      if(password !== confirmPassword) {
        errorP.textContent = 'ÙƒÙ„Ù…ØªØ§ Ø§Ù„Ø³Ø± ØºÙŠØ± Ù…ØªØ·Ø§Ø¨Ù‚ØªÙŠÙ†.';
        return;
      }
      if(users[username]) {
        errorP.textContent = 'Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…ÙˆØ¬ÙˆØ¯ Ø¨Ø§Ù„ÙØ¹Ù„.';
        return;
      }
      users[username] = {
        username,
        name,
        password,
        createdAt: new Date().toISOString(),
        isAdmin: false,
        chats: [],
        voiceRooms: [],
        avatar: ""
      };
      saveData();
      alert('ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨ Ø¨Ù†Ø¬Ø§Ø­.');
      document.getElementById('account-created-modal').classList.remove('hidden');
    });
    
    document.getElementById('dismiss-account-created').addEventListener('click', () => {
      document.getElementById('account-created-modal').classList.add('hidden');
      showScreen('login-screen');
    });
    document.getElementById('close-account-created-modal').addEventListener('click', () => {
      document.getElementById('account-created-modal').classList.add('hidden');
      showScreen('login-screen');
    });
    
    // ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
    document.getElementById('login-button').addEventListener('click', () => {
      // ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ù…Ù† localStorage
      refreshUsers();
      const username = document.getElementById('login-username').value.trim();
      const password = document.getElementById('login-password').value;
      const errorP = document.getElementById('login-error');
      errorP.textContent = '';
    
      if(bannedUsers[username]) {
        errorP.textContent = 'ØªÙ… Ø­Ø¶Ø±Ùƒ Ù…Ù† Ù‚Ø¨Ù„ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©.';
        return;
      }
      if(users[username] && users[username].password === password) {
        currentUser = users[username];
        document.getElementById('welcome-name').textContent = currentUser.name;
        document.getElementById('admin-icon').style.display = currentUser.isAdmin ? 'inline-block' : 'none';
        applyUserSettings();
        document.getElementById('user-avatar').src = currentUser.avatar || '';
        // Ø¥Ù†Ø´Ø§Ø¡ Ø§ØªØµØ§Ù„ Socket.IO Ø¨Ø¹Ø¯ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
        socket = io();
        showScreen('main-screen');
      } else {
        errorP.textContent = 'Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯Ø®ÙˆÙ„ ØºÙŠØ± ØµØ­ÙŠØ­Ø©.';
      }
    });
    
    // ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬
    document.getElementById('logout-button').addEventListener('click', () => {
      currentUser = null;
      if(socket) { socket.disconnect(); socket = null; }
      showScreen('login-screen');
    });
    
    /***** ØªØ·Ø¨ÙŠÙ‚ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¹Ù„Ù‰ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© *****/
    function applyUserSettings() {
      document.body.style.fontSize = userSettings.fontSize + 'px';
      if(userSettings.background === 'dark') {
        document.body.style.backgroundColor = '#2f3136';
      } else {
        document.body.style.backgroundColor = '#fff';
      }
      document.querySelectorAll('button').forEach(btn => {
        if(userSettings.buttonColor === 'blue') {
          btn.style.backgroundColor = 'var(--primary-color)';
          btn.style.color = '#fff';
        } else {
          btn.style.backgroundColor = 'yellow';
          btn.style.color = '#000';
        }
      });
    }
    
    /***** ØªØ­Ø¯ÙŠØ« Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ØºØ±Ù ÙÙŠ Sidebar *****/
    function updateJoinedRooms() {
      const sidebar = document.getElementById('rooms-sidebar');
      sidebar.innerHTML = '<h4>Ø§Ù„ØºØ±Ù Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©</h4>';
      if(currentUser) {
        currentUser.chats.forEach(code => {
          const roomDiv = document.createElement('div');
          roomDiv.className = 'room-item';
          roomDiv.innerHTML = `<span class="delete-btn" data-type="chat" data-code="${code}">Ø­Ø°Ù</span>Ø´Ø§Øª: ${code}`;
          roomDiv.addEventListener('click', () => {
            document.getElementById('chat-room-code').textContent = code;
            loadChatMessages(code);
            if(socket) { socket.emit('joinRoom', code); }
            showScreen('chat-room-screen');
          });
          sidebar.appendChild(roomDiv);
        });
        currentUser.voiceRooms.forEach(code => {
          const roomDiv = document.createElement('div');
          roomDiv.className = 'room-item';
          roomDiv.innerHTML = `<span class="delete-btn" data-type="voice" data-code="${code}">Ø­Ø°Ù</span>ÙÙˆÙŠØ³: ${code}`;
          roomDiv.addEventListener('click', () => {
            document.getElementById('voice-room-code').textContent = code;
            loadVoiceParticipants(code);
            showScreen('voice-room-screen');
          });
          sidebar.appendChild(roomDiv);
        });
      }
      document.querySelectorAll('.delete-btn').forEach(btn => {
        btn.addEventListener('click', e => {
          e.stopPropagation();
          const type = btn.getAttribute('data-type');
          const code = btn.getAttribute('data-code');
          if(confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø¹Ù†ØµØ± Ù…Ù† Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©ØŸ')) {
            if(type === 'chat') {
              currentUser.chats = currentUser.chats.filter(c => c !== code);
            } else {
              currentUser.voiceRooms = currentUser.voiceRooms.filter(c => c !== code);
            }
            users[currentUser.username] = currentUser;
            saveData();
            updateJoinedRooms();
          }
        });
      });
    }
    
    /***** ØºØ±ÙØ© Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© (realâ€‘time) *****/
    document.getElementById('chat-icon').addEventListener('click', () => showScreen('chat-code-screen'));
    document.getElementById('cancel-chat-code').addEventListener('click', () => showScreen('main-screen'));
    document.getElementById('enter-chat-code').addEventListener('click', () => {
      const code = document.getElementById('chat-code-input').value.trim();
      const errorP = document.getElementById('chat-code-error');
      errorP.textContent = '';
      if(!code) {
        errorP.textContent = 'Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø´ÙŠÙØ±Ø©.';
        return;
      }
      if(!chats[code]) {
        chats[code] = { code, messages: [] };
        saveData();
      }
      if(!currentUser.chats.includes(code)) {
        currentUser.chats.push(code);
        users[currentUser.username] = currentUser;
        saveData();
      }
      document.getElementById('chat-room-code').textContent = code;
      loadChatMessages(code);
      if(socket) { socket.emit('joinRoom', code); }
      showScreen('chat-room-screen');
    });
    
    function loadChatMessages(code) {
      const chatDiv = document.getElementById('chat-messages');
      chatDiv.innerHTML = '';
      if(chats[code] && chats[code].messages) {
        chats[code].messages.forEach(msg => {
          addChatMessage(msg, false);
        });
      }
    }
    
    function addChatMessage(msg, saveLocal = true) {
      const chatDiv = document.getElementById('chat-messages');
      const msgDiv = document.createElement('div');
      msgDiv.className = 'chat-message';
      if(users[msg.sender] && users[msg.sender].avatar) {
        const avatarImg = document.createElement('img');
        avatarImg.src = users[msg.sender].avatar;
        avatarImg.style.width = '20px';
        avatarImg.style.height = '20px';
        avatarImg.style.borderRadius = '50%';
        avatarImg.style.marginRight = '5px';
        msgDiv.appendChild(avatarImg);
      }
      const contentSpan = document.createElement('span');
      contentSpan.textContent = msg.sender + ': ' + msg.text;
      msgDiv.appendChild(contentSpan);
      if(msg.sender === currentUser.username) {
        const editBtn = document.createElement('button');
        editBtn.textContent = 'Edit';
        editBtn.addEventListener('click', e => {
          e.stopPropagation();
          const newText = prompt('ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø±Ø³Ø§Ù„Ø©:', msg.text);
          if(newText) {
            msg.text = newText;
            saveData();
            loadChatMessages(document.getElementById('chat-room-code').textContent);
          }
        });
        msgDiv.appendChild(editBtn);
        const deleteBtn = document.createElement('button');
        deleteBtn.textContent = 'Delete';
        deleteBtn.addEventListener('click', e => {
          e.stopPropagation();
          if(confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ø§Ù„Ø±Ø³Ø§Ù„Ø©ØŸ')) {
            const roomCode = document.getElementById('chat-room-code').textContent;
            chats[roomCode].messages.splice(chats[roomCode].messages.indexOf(msg), 1);
            saveData();
            loadChatMessages(roomCode);
          }
        });
        msgDiv.appendChild(deleteBtn);
      }
      chatDiv.appendChild(msgDiv);
      if(saveLocal) {
        const roomCode = document.getElementById('chat-room-code').textContent;
        if(!chats[roomCode].messages) chats[roomCode].messages = [];
        chats[roomCode].messages.push(msg);
        saveData();
      }
    }
    
    document.getElementById('send-chat-message').addEventListener('click', () => {
      const input = document.getElementById('chat-input');
      const text = input.value.trim();
      if(!text) return;
      const roomCode = document.getElementById('chat-room-code').textContent;
      const msg = { sender: currentUser.username, text, timestamp: new Date().toISOString(), room: roomCode };
      if(socket) { socket.emit('chatMessage', msg); }
      addChatMessage(msg);
      input.value = '';
      document.getElementById('typing-indicator').textContent = '';
    });
    
    document.getElementById('send-file-chat').addEventListener('click', () => {
      alert('Ù…ÙŠØ²Ø© Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØµÙˆØ±/Ø§Ù„Ù…Ù„ÙØ§Øª Ù‚ÙŠØ¯ Ø§Ù„ØªØ·ÙˆÙŠØ±.');
    });
    
    // Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ù…Ù† Ø§Ù„Ø®Ø§Ø¯Ù… Ø¹Ø¨Ø± Socket.IO
    function setupSocketListeners() {
      if(socket) {
        socket.on('message', data => {
          const roomCode = document.getElementById('chat-room-code').textContent;
          if(data.room === roomCode) { addChatMessage(data, false); }
        });
      }
    }
    setTimeout(setupSocketListeners, 1000);
    
    let typingTimer;
    document.getElementById('chat-input').addEventListener('input', () => {
      clearTimeout(typingTimer);
      const indicator = document.getElementById('typing-indicator');
      if(document.getElementById('chat-input').value.trim() !== ''){
        indicator.textContent = 'Ø£Ù†Øª ØªÙƒØªØ¨...';
        typingTimer = setTimeout(() => { indicator.textContent = ''; }, 1000);
      } else { indicator.textContent = ''; }
    });
    
    /***** ØºØ±ÙØ© Ø§Ù„ÙÙˆÙŠØ³ (Ù…Ø­Ø§ÙƒØ§Ø©) *****/
    document.getElementById('voice-icon').addEventListener('click', () => showScreen('voice-code-screen'));
    document.getElementById('cancel-voice-code').addEventListener('click', () => showScreen('main-screen'));
    document.getElementById('enter-voice-code').addEventListener('click', () => {
      const code = document.getElementById('voice-code-input').value.trim();
      const errorP = document.getElementById('voice-code-error');
      errorP.textContent = '';
      if(!code) { errorP.textContent = 'Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø´ÙŠÙØ±Ø©.'; return; }
      if(!voiceRooms[code]) { voiceRooms[code] = { code, participants: [] }; saveData(); }
      if(!voiceRooms[code].participants.includes(currentUser.username)) {
        voiceRooms[code].participants.push(currentUser.username);
        if(!currentUser.voiceRooms.includes(code)) { currentUser.voiceRooms.push(code); }
        users[currentUser.username] = currentUser;
        saveData();
      }
      document.getElementById('voice-room-code').textContent = code;
      loadVoiceParticipants(code);
      showScreen('voice-room-screen');
    });
    
    function loadVoiceParticipants(code) {
      const container = document.getElementById('voice-participants');
      container.innerHTML = '';
      voiceRooms[code].participants.forEach(username => {
        const participantDiv = document.createElement('div');
        participantDiv.className = 'participant';
        participantDiv.innerHTML = `<strong>${username}</strong><br><small>${users[username] ? users[username].name : ''}</small>`;
        container.appendChild(participantDiv);
      });
    }
    
    document.getElementById('back-from-voice-room').addEventListener('click', exitVoiceRoomAndReturn);
    document.getElementById('exit-voice-room').addEventListener('click', exitVoiceRoomAndReturn);
    function exitVoiceRoomAndReturn() {
      const code = document.getElementById('voice-room-code').textContent;
      if(voiceRooms[code]) {
        voiceRooms[code].participants = voiceRooms[code].participants.filter(u => u !== currentUser.username);
        saveData();
      }
      showScreen('main-screen');
    }
    
    document.getElementById('mic-button').addEventListener('click', () => {
      if(userSettings.micMode === 'press') {
        alert('ØµÙˆØª Ø±Ø§Ø¯ÙŠÙˆ Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø§ÙŠÙƒ (Ù…Ø­Ø§ÙƒØ§Ø©)');
      } else { alert('Ø§Ù„Ù…ÙŠÙƒ ÙÙŠ ÙˆØ¶Ø¹ Ø§Ù„ØªØ¨Ø¯ÙŠÙ„ â€“ ÙŠØ¹Ù…Ù„/Ù…ØºÙ„Ù‚'); }
    });
    document.getElementById('speaker-button').addEventListener('click', () => {
      alert('ØªÙ… ØªØ¨Ø¯ÙŠÙ„ Ø­Ø§Ù„Ø© Ø§Ù„Ø³Ù…Ø§Ø¹Ø©.');
    });
    
    /***** Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ *****/
    document.getElementById('profile-settings').addEventListener('click', () => {
      document.getElementById('profile-modal').classList.remove('hidden');
    });
    document.getElementById('close-profile-modal').addEventListener('click', () => {
      document.getElementById('profile-modal').classList.add('hidden');
    });
    document.getElementById('update-name').addEventListener('click', () => {
      const newName = document.getElementById('new-name').value.trim();
      if(newName) {
        currentUser.name = newName;
        users[currentUser.username] = currentUser;
        saveData();
        document.getElementById('welcome-name').textContent = newName;
        alert('ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø§Ø³Ù….');
      }
    });
    document.getElementById('update-username').addEventListener('click', () => {
      const currPass = document.getElementById('current-password-username').value;
      const newUsername = document.getElementById('new-username').value.trim();
      if(currPass === currentUser.password && newUsername && newUsername.length >= 3) {
        if(users[newUsername]) {
          alert('Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…ÙˆØ¬ÙˆØ¯ Ø¨Ø§Ù„ÙØ¹Ù„.');
        } else {
          delete users[currentUser.username];
          currentUser.username = newUsername;
          users[newUsername] = currentUser;
          saveData();
          alert('ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù….');
        }
      } else { alert('Ø¨ÙŠØ§Ù†Ø§Øª ØºÙŠØ± ØµØ­ÙŠØ­Ø©.'); }
    });
    document.getElementById('update-password').addEventListener('click', () => {
      const currPass = document.getElementById('current-password-pass').value;
      const newPassword = document.getElementById('new-password').value;
      if(currPass === currentUser.password && newPassword.length >= 6) {
        currentUser.password = newPassword;
        users[currentUser.username] = currentUser;
        saveData();
        alert('ØªÙ… ØªØ­Ø¯ÙŠØ« ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±.');
      } else { alert('Ø¨ÙŠØ§Ù†Ø§Øª ØºÙŠØ± ØµØ­ÙŠØ­Ø© Ø£Ùˆ ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø± Ù‚ØµÙŠØ±Ø©.'); }
    });
    document.getElementById('update-avatar').addEventListener('click', () => {
      const newAvatar = document.getElementById('new-avatar').value.trim();
      if(newAvatar) {
        currentUser.avatar = newAvatar;
        users[currentUser.username] = currentUser;
        saveData();
        document.getElementById('user-avatar').src = newAvatar;
        alert('ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ø´Ø®ØµÙŠØ©.');
      }
    });
    document.getElementById('cancel-update-avatar').addEventListener('click', () => {
      document.getElementById('new-avatar').value = '';
    });
    
    /***** Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù„ØºØ© *****/
    document.getElementById('language-settings').addEventListener('click', () => {
      document.getElementById('language-select').value = userSettings.language;
      document.getElementById('language-modal').classList.remove('hidden');
    });
    document.getElementById('close-language-modal').addEventListener('click', () => {
      document.getElementById('language-modal').classList.add('hidden');
    });
    document.getElementById('save-language').addEventListener('click', () => {
      userSettings.language = document.getElementById('language-select').value;
      saveData();
      alert('ØªÙ… Ø­ÙØ¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù„ØºØ©.');
      document.getElementById('language-modal').classList.add('hidden');
    });
    
    /***** Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØµÙˆØª *****/
    document.getElementById('sound-settings').addEventListener('click', () => {
      document.getElementById('mic-volume').value = userSettings.micVolume;
      document.getElementById('speaker-volume').value = userSettings.speakerVolume;
      document.getElementById('mic-mode').value = userSettings.micMode;
      document.getElementById('sound-modal').classList.remove('hidden');
    });
    document.getElementById('close-sound-modal').addEventListener('click', () => {
      document.getElementById('sound-modal').classList.add('hidden');
    });
    document.getElementById('save-sound-settings').addEventListener('click', () => {
      userSettings.micVolume = document.getElementById('mic-volume').value;
      userSettings.speakerVolume = document.getElementById('speaker-volume').value;
      userSettings.micMode = document.getElementById('mic-mode').value;
      saveData();
      alert('ØªÙ… Ø­ÙØ¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØµÙˆØª.');
      document.getElementById('sound-modal').classList.add('hidden');
    });
    
    /***** Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù†Øµ *****/
    document.getElementById('text-settings').addEventListener('click', () => {
      document.getElementById('font-size-range').value = userSettings.fontSize;
      document.getElementById('text-modal').classList.remove('hidden');
    });
    document.getElementById('close-text-modal').addEventListener('click', () => {
      document.getElementById('text-modal').classList.add('hidden');
    });
    document.getElementById('save-text-settings').addEventListener('click', () => {
      userSettings.fontSize = document.getElementById('font-size-range').value;
      saveData();
      applyUserSettings();
      alert('ØªÙ… Ø­ÙØ¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù†Øµ.');
      document.getElementById('text-modal').classList.add('hidden');
    });
    
    /***** Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…Ø¸Ù‡Ø± *****/
    document.getElementById('appearance-settings').addEventListener('click', () => {
      document.getElementById('background-select').value = userSettings.background;
      document.getElementById('button-color-select').value = userSettings.buttonColor;
      document.getElementById('appearance-modal').classList.remove('hidden');
    });
    document.getElementById('close-appearance-modal').addEventListener('click', () => {
      document.getElementById('appearance-modal').classList.add('hidden');
    });
    document.getElementById('save-appearance-settings').addEventListener('click', () => {
      userSettings.background = document.getElementById('background-select').value;
      userSettings.buttonColor = document.getElementById('button-color-select').value;
      saveData();
      applyUserSettings();
      alert('ØªÙ… Ø­ÙØ¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…Ø¸Ù‡Ø±.');
      document.getElementById('appearance-modal').classList.add('hidden');
    });
    
    /***** Ø¯Ø¹Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… (Ø´Ø§Øª Ù…Ø¹ Ø§Ù„Ø¯Ø¹Ù…) *****/
    document.getElementById('support-settings').addEventListener('click', () => {
      document.getElementById('support-messages').innerHTML = '';
      document.getElementById('support-modal').classList.remove('hidden');
    });
    document.getElementById('close-support-modal').addEventListener('click', () => {
      document.getElementById('support-modal').classList.add('hidden');
    });
    document.getElementById('send-support-message').addEventListener('click', () => {
      const msg = document.getElementById('support-input').value.trim();
      if(msg) {
        const supportDiv = document.getElementById('support-messages');
        const msgDiv = document.createElement('div');
        msgDiv.className = 'chat-message';
        msgDiv.textContent = currentUser.username + ': ' + msg;
        supportDiv.appendChild(msgDiv);
        document.getElementById('support-input').value = '';
        setTimeout(() => {
          const reply = document.createElement('div');
          reply.className = 'chat-message';
          reply.textContent = 'Ø§Ù„Ø¯Ø¹Ù…: ØªÙ… Ø§Ø³ØªÙ„Ø§Ù… Ø±Ø³Ø§Ù„ØªÙƒØŒ Ø³Ù†ØªÙˆØ§ØµÙ„ Ù…Ø¹Ùƒ Ù‚Ø±ÙŠØ¨Ø§Ù‹.';
          supportDiv.appendChild(reply);
        }, 1000);
      }
    });

    const socket = io();

socket.on("message", (msg) => {
    console.log("Ø±Ø³Ø§Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø©:", msg);
});

function sendMessage(msg) {
    socket.emit("message", msg);
    }); 
    
    /***** Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† (Ù„Ù„Ø£Ø¯Ù…Ù†) *****/
    document.getElementById('manage-users').addEventListener('click', () => {
      populateUserList('');
      document.getElementById('user-management-modal').classList.remove('hidden');
    });
    document.getElementById('close-user-management-modal').addEventListener('click', () => {
      document.getElementById('user-management-modal').classList.add('hidden');
    });
    document.getElementById('user-search').addEventListener('input', (e) => {
      populateUserList(e.target.value.trim());
    });
    function populateUserList(filter) {
      const listDiv = document.getElementById('user-list');
      listDiv.innerHTML = '';
      Object.keys(users).forEach(username => {
        if(filter && !username.includes(filter)) return;
        const userDiv = document.createElement('div');
        userDiv.style.border = '1px solid var(--input-bg)';
        userDiv.style.padding = '5px';
        userDiv.style.margin = '5px 0';
        userDiv.style.cursor = 'pointer';
        userDiv.textContent = username;
        userDiv.addEventListener('click', () => {
          const user = users[username];
          const newName = prompt('Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ: ' + user.name + '\nØ£Ø¯Ø®Ù„ Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯ (Ø£Ùˆ Ø§ØªØ±ÙƒÙ‡ ÙØ§Ø±ØºØ§Ù‹):');
          const newUsername = prompt('ÙŠÙˆØ²Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ: ' + user.username + '\nØ£Ø¯Ø®Ù„ ÙŠÙˆØ²Ø± Ø¬Ø¯ÙŠØ¯ (Ø£Ùˆ Ø§ØªØ±ÙƒÙ‡ ÙØ§Ø±ØºØ§Ù‹):');
          const newPass = prompt('ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø± Ø§Ù„Ø­Ø§Ù„ÙŠØ©: ' + user.password + '\nØ£Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ø³Ø± Ø¬Ø¯ÙŠØ¯Ø© (Ø£Ùˆ Ø§ØªØ±ÙƒÙ‡ ÙØ§Ø±ØºØ§Ù‹):');
          if(newName) user.name = newName;
          if(newUsername && !users[newUsername]) {
            delete users[user.username];
            user.username = newUsername;
          }
          if(newPass && newPass.length >= 6) user.password = newPass;
          users[user.username] = user;
          saveData();
          alert('ØªÙ… ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù….');
          populateUserList(filter);
        });
        listDiv.appendChild(userDiv);
      });
    }
    
    /***** Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø­Ø¶Ø± *****/
    document.getElementById('ban-management').addEventListener('click', () => {
      const action = prompt('Ø§ÙƒØªØ¨ "list" Ù„Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø­Ø¶ÙˆØ±ÙŠÙ†ØŒ "ban" Ù„Ø­Ø¸Ø± Ù…Ø³ØªØ®Ø¯Ù…ØŒ Ø£Ùˆ "unban" Ù„Ø±ÙØ¹ Ø§Ù„Ø­Ø¸Ø±:');
      if(action === 'list') {
        let list = Object.keys(bannedUsers).map(u => u + ' (Ø³Ø¨Ø¨: ' + bannedUsers[u] + ')').join('\n');
        alert(list ? list : 'Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø³ØªØ®Ø¯Ù…ÙˆÙ† Ù…Ø­Ø¶ÙˆØ±ÙˆÙ†.');
      } else if(action === 'ban') {
        const username = prompt('Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù…Ø±Ø§Ø¯ Ø­Ø¶Ø±Ù‡:');
        const reason = prompt('Ø£Ø¯Ø®Ù„ Ø³Ø¨Ø¨ Ø§Ù„Ø­Ø¸Ø±:');
        if(username && users[username]) {
          bannedUsers[username] = reason || 'Ø¨Ø¯ÙˆÙ† Ø³Ø¨Ø¨';
          saveData();
          alert('ØªÙ… Ø­Ø¸Ø± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ' + username);
          if(currentUser.username === username) {
            currentUser = null;
            showScreen('login-screen');
          }
        }
      } else if(action === 'unban') {
        const username = prompt('Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù„Ø±ÙØ¹ Ø§Ù„Ø­Ø¸Ø±:');
        if(username && bannedUsers[username]) {
          delete bannedUsers[username];
          saveData();
          alert('ØªÙ… Ø±ÙØ¹ Ø§Ù„Ø­Ø¸Ø± Ø¹Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ' + username);
        }
      }
    });
    
    /***** Ø¥Ø¶Ø§ÙØ© Ø¥Ø¯Ø§Ø±ÙŠ *****/
    document.getElementById('add-admin').addEventListener('click', () => {
      const username = prompt('Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù…Ø±Ø§Ø¯ ØªØ±Ù‚ÙŠØªÙ‡ Ù„Ø¥Ø¯Ø§Ø±ÙŠ:');
      if(username && users[username]) {
        users[username].isAdmin = true;
        saveData();
        alert('ØªÙ… Ø¥Ø¶Ø§ÙØ© ' + username + ' ÙƒØ¥Ø¯Ø§Ø±ÙŠ.');
      }
    });
    
    /***** Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªØ¹Ù…ÙŠÙ… *****/
    document.getElementById('broadcast-all').addEventListener('click', () => {
      const message = prompt('Ø£Ø¯Ø®Ù„ Ø§Ù„ØªØ¹Ù…ÙŠÙ… Ù„Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†:');
      if(message) { alert('ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªØ¹Ù…ÙŠÙ…: ' + message); }
    });
    document.getElementById('broadcast-user').addEventListener('click', () => {
      const username = prompt('Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…:');
      const message = prompt('Ø£Ø¯Ø®Ù„ Ø§Ù„ØªØ¹Ù…ÙŠÙ… Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…:');
      if(username && message) { alert('ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªØ¹Ù…ÙŠÙ… Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… ' + username + ': ' + message); }
    });
    
    /***** ØªØµÙÙŠØª Ø§Ù„Ø´Ø§ØªØ§Øª *****/
    document.getElementById('clear-chats').addEventListener('click', () => {
      if(confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø¥Ø¹Ø§Ø¯Ø© ØªØµÙÙŠØª Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø´Ø§ØªØ§ØªØŸ (Ù…Ø§ Ø¹Ø¯Ø§ Ø§Ù„Ø´Ø§Øª 1 Ùˆ2 Ùˆ3)')) {
        Object.keys(chats).forEach(code => {
          if(code !== '1' && code !== '2' && code !== '3') {
            chats[code].messages = [];
          }
        });
        saveData();
        alert('ØªÙ… ØªØµÙÙŠØª Ø§Ù„Ø´Ø§ØªØ§Øª.');
      }
    });
    
    /***** Ø¥Ø¹Ø·Ø§Ø¡ ÙˆØ¥Ø²Ø§Ù„Ø© Ø¥Ø°Ù† Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù„ØºØ±Ù Ø§Ù„Ø´Ø§Øª/Ø§Ù„ÙÙˆÙŠØ³ *****/
    document.getElementById('grant-permission').addEventListener('click', () => {
      const targetUser = prompt('Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…:');
      const type = prompt('Ø£Ø¯Ø®Ù„ Ù†ÙˆØ¹ Ø§Ù„ØºØ±ÙØ© ("chat" Ø£Ùˆ "voice"):');
      const code = prompt('Ø£Ø¯Ø®Ù„ Ø§Ù„Ø´ÙŠÙØ±Ø© (Ù…Ø«Ø§Ù„: 1ØŒ 2ØŒ Ø£Ùˆ 3):');
      if(targetUser && type && code) {
        if(!permissions[targetUser]) permissions[targetUser] = {};
        permissions[targetUser][type] = code;
        saveData();
        alert('ØªÙ… Ø¥Ø¹Ø·Ø§Ø¡ Ø¥Ø°Ù† Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… ' + targetUser);
      }
    });
    document.getElementById('remove-permission').addEventListener('click', () => {
      const targetUser = prompt('Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù„Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø¥Ø°Ù†:');
      if(targetUser && permissions[targetUser]) {
        delete permissions[targetUser];
        saveData();
        alert('ØªÙ… Ø¥Ø²Ø§Ù„Ø© Ø¥Ø°Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ' + targetUser);
      }
    });
    
    /***** Ø¯Ø¹Ù… Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© (Ø§Ù„Ø¯Ø¹Ù…) *****/
    document.getElementById('admin-support').addEventListener('click', () => {
      alert('ÙØªØ­ Ø´Ø§Øª Ø§Ù„Ø¯Ø¹Ù… Ù…Ø¹ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† (Ù…Ø­Ø§ÙƒØ§Ø©).');
    });
    
    // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø¯ÙŠØ± (Owner) ÙˆØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§ØªÙ‡ Ø¯Ø§Ø¦Ù…Ù‹Ø§
    users['l.0v'] = {
      username: 'l.0v',
      name: 'Vladimir Dark',
      password: 'fty567fty',
      createdAt: new Date().toISOString(),
      isAdmin: true,
      chats: [],
      voiceRooms: [],
      avatar: 'https://via.placeholder.com/100?text=Owner'
    };
    saveData();
    
    // Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©ØŒ Ø¹Ø±Ø¶ Ø´Ø§Ø´Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
    showScreen('login-screen');
    
    // Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ù…Ù† Ø§Ù„Ø®Ø§Ø¯Ù… Ø¹Ø¨Ø± Socket.IO
    function setupSocketListeners() {
      if(socket) {
        socket.on('message', data => {
          const roomCode = document.getElementById('chat-room-code').textContent;
          if(data.room === roomCode) { addChatMessage(data, false); }
        });
      }
    }
    setTimeout(setupSocketListeners, 1000);
  </script>
</body>
</html>
